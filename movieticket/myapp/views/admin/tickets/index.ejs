<%- include('../../partials/header', { title, user }) %>

<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h4 mb-0">Tickets • All Users</h1>
    <form class="d-flex" role="search" method="get">
      <input class="form-control form-control-sm me-2" type="search" name="q" value="<%= q %>" placeholder="Search name or email">
      <button class="btn btn-sm btn-primary">Search</button>
    </form>
  </div>

  <div class="card" style="background:#121519;border:1px solid #2a2f36;border-radius:14px;">
    <div class="table-responsive">
      <table class="table table-dark table-striped align-middle mb-0">
        <thead>
          <tr>
            <th class="text-nowrap">User</th>
            <th class="text-nowrap">Email</th>
            <th class="text-end text-nowrap">Orders</th>
            <th class="text-end text-nowrap">Paid</th>
            <th class="text-end text-nowrap">Tickets</th>
            <th class="text-end text-nowrap">Total Spent</th>
            <th class="text-nowrap">Last Order</th>
            <th class="text-end" style="width:160px;white-space:nowrap;">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if (!rows || rows.length === 0) { %>
            <tr>
              <td colspan="8" class="text-center fw-medium py-5">No users found.</td>
            </tr>
          <% } else { rows.forEach(r => { %>
            <tr>
              <td>
                <div class="fw-semibold"><%= r.name %></div>
                <div class="small text-secondary">#<%= r.id %></div>
              </td>
              <td class="fw-medium"><%= r.email %></td>
              <td class="text-end fw-medium"><span ><%= r.orders_count %></span></td>
              <td class="text-end fw-medium"><span ><%= r.paid_orders %></span></td>
              <td class="text-end fw-medium"><span ><%= r.tickets_count %></span></td>
              <td class="text-end fw-medium">฿<%= Number(r.total_spent||0).toLocaleString('th-TH') %></td>
              <td class="fw-medium">
                <%= r.last_order_at ? (new Date(r.last_order_at)).toISOString().slice(0,19).replace('T',' ') : '—' %>
              </td>
              <td class="text-end fw-medium" style="white-space:nowrap;">
                <a class="btn btn-sm btn-outline-info" href="/admin/tickets/<%= r.id %>">View tickets</a>
              </td>
            </tr>
          <% }) } %>
        </tbody>
      </table>
    </div>
  </div>

  <% if (totalPages > 1) { %>
    <nav class="mt-3">
      <ul class="pagination pagination-sm mb-0">
        <% for (let p=1; p<=totalPages; p++){ %>
          <li class="page-item <%= p===page ? 'active' : '' %>">
            <a class="page-link" href="?q=<%= encodeURIComponent(q) %>&page=<%= p %>"><%= p %></a>
          </li>
        <% } %>
      </ul>
    </nav>
  <% } %>
</div>

<%- include('../../partials/footer') %>
