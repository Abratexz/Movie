<%- include('../partials/header', { title, user }) %>

<style>
  .movie-card {
    background: linear-gradient(135deg, #1a1a1a 0%, #2d1b1b 100%);
    border-radius: 15px;
    overflow: hidden;
    position: relative;
    transition: all 0.3s ease;
    border: 1px solid rgba(220, 53, 69, 0.1);
    height: 100%;
  }
  .movie-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 20px 40px rgba(133, 114, 116, 0.3);
    border-color: #fff;
  }
  .movie-poster-container { position: relative; overflow: hidden; height: 400px; }
  .movie-poster { width: 100%; height: 100%; object-fit: cover; transition: all .3s ease; }
  .movie-card:hover .movie-poster { transform: scale(1.02); filter: brightness(.4); }

  .favorite-button {
    position: absolute;
    top: 15px; right: 15px;
    width: 40px; height: 40px;
    background: rgba(0,0,0,.7);
    border: 2px solid #fff; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #fff; font-size: 16px;
    transition: all .3s ease; cursor: pointer; z-index: 15;
  }
  .favorite-button:hover { background: rgba(220,53,69,.8); color: #fff; }

  .movie-info-overlay {
    position: absolute; bottom: 0; left: 0; right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,.9));
    padding: 40px 20px 50px; color: #fff; z-index: 1;
  }
  .movie-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 8px; line-height: 1.3; text-shadow: 0 2px 4px rgba(0,0,0,.5); }
  .movie-genres { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 8px; }
  .genre-badge { background: rgba(255,255,255,.2); color: #fff; padding: 3px 8px; border-radius: 12px; font-size: .7rem; text-transform: uppercase; font-weight: 500; border: 1px solid rgba(255,255,255,.3); }
  .movie-duration { font-size: .8rem; color: #ffc107; display: flex; align-items: center; gap: 5px; }
  .movie-duration::before { content:'üïí'; font-size: 12px; }

  .more-info-btn {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(.8);
    background: rgba(255,255,255,.95); color: #333; border: none; padding: 10px 20px; border-radius: 20px;
    font-weight: bold; font-size: .85rem; text-transform: uppercase; letter-spacing: .5px; transition: all .3s ease;
    opacity: 0; z-index: 10; box-shadow: 0 5px 15px rgba(0,0,0,.3);
  }
  .movie-card:hover .more-info-btn { opacity: 1; transform: translate(-50%, -50%) scale(1); }
  .more-info-btn:hover { background: #fff; color: #000; transform: translate(-50%, -50%) scale(1.02); box-shadow: 0 8px 20px rgba(0,0,0,.4); }

  .category-nav { background: rgba(0,0,0,.3); border-radius: 25px; padding: 10px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,.1); }
  .category-nav a { padding: 12px 30px; border-radius: 20px; transition: all .3s ease; text-transform: uppercase; font-weight: 600; letter-spacing: .5px; }
  .category-nav a.active { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: #fff !important; box-shadow: 0 5px 15px rgba(220,53,69,.4); }
  .category-nav a:not(.active):hover { background: rgba(255,255,255,.1); color: #fff !important; }

  .digital-badge { position: absolute; bottom: 15px; left: 15px; background: rgba(0,123,255,.9); color: #fff; padding: 4px 8px; border-radius: 4px; font-size: .7rem; font-weight: bold; text-transform: uppercase; z-index: 2; }
  .no-movies { text-align: center; color: rgba(255,255,255,.7); font-size: 1.2rem; margin: 60px 0; }
  .movies-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; margin-top: 40px; }

  @media (max-width: 768px) {
    .movies-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
    .movie-title { font-size: 1rem; }
    .category-nav a { padding: 10px 20px; font-size: .9rem; }
  }

  /* heart animation */
  @keyframes heartPop {
    0% { transform: scale(.9); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }
  .favorite-button i.heart-pop { animation: heartPop 250ms ease; }
</style>

<div class="container my-5">
  <nav class="d-flex justify-content-center mb-5" aria-label="Movie categories">
    <div class="category-nav d-flex gap-3">
      <a href="/movies/now-showing"
         class="text-decoration-none <%= category === 'now' ? 'active' : 'text-white-50' %>"
         aria-current="<%= category === 'now' ? 'page' : 'false' %>">Now Showing</a>
      <a href="/movies/coming-soon"
         class="text-decoration-none <%= category === 'coming' ? 'active' : 'text-white-50' %>"
         aria-current="<%= category === 'coming' ? 'page' : 'false' %>">Coming Soon</a>
    </div>
  </nav>

  <% const list = Array.isArray(movies) ? movies : []; %>
  <% if (list.length === 0) { %>
    <div class="no-movies"><p>üé¨ No movies available at the moment.</p></div>
  <% } else { %>
    <div class="movies-grid">
      <% list.forEach(m => { %>
        <div class="movie-card">
          <div class="movie-poster-container">

            <!-- Favorite Button (saves via AJAX) -->
            <button class="favorite-button" type="button"
            data-movie-id="<%= m.id %>"
            aria-label="<%= m.is_favorite ? 'Remove from favorites' : 'Add to favorites' %>">
              <i class="<%= m.is_favorite ? 'fas' : 'far' %> fa-heart"></i>
            </button>

            <!-- Poster -->
            <img src="/images/<%= m.poster_url %>"
                 alt="<%= m.title %> poster"
                 class="movie-poster"
                 loading="lazy"
                 onerror="this.onerror=null;this.src='/images/posters/default.png';" />

            <div class="digital-badge">Digital</div>

            <div class="movie-info-overlay">
              <div class="movie-title">
                <%= (m.title || '').length > 40 ? m.title.substring(0, 40) + '‚Ä¶' : (m.title || '') %>
              </div>
              <div class="movie-genres">
                <% if (m.genres) { %>
                  <% m.genres.split(',').slice(0, 3).forEach(g => { %>
                    <span class="genre-badge"><%= g.trim() %></span>
                  <% }) %>
                <% } %>
              </div>
              <div class="movie-duration">
                <%= m.duration_min ? `${Math.floor(m.duration_min / 60)}H ${m.duration_min % 60}M` : 'TBA' %>
              </div>
            </div>
          </div>

          <button class="more-info-btn" onclick="location.href='/movies/<%= m.id %>/showtimes'">More Info</button>

          <a href="/movies/<%= m.id %>/showtimes"
             class="stretched-link"
             style="z-index: -1;"
             aria-label="View showtimes for <%= m.title %>"></a>
        </div>
      <% }) %>
    </div>
  <% } %>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<script>
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.favorite-button');
    if (!btn) return;
  
    e.preventDefault();
    e.stopPropagation();
  
    const icon = btn.querySelector('i');
    const movieId = btn.dataset.movieId;
  
    try {
      const resp = await fetch(`/favorites/${movieId}/toggle`, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
  
      if (resp.status === 401) {
        const next = encodeURIComponent(location.pathname + location.search);
        return (window.location.href = `/auth/login?next=${next}`);
      }
  
      const data = await resp.json();
      if (data.ok) {
        // If you chose ‚Äúalways show‚Äù:
        icon.classList.toggle('fas', data.favorited);
        icon.classList.toggle('far', !data.favorited);
  
        // If you chose ‚Äúhide when favorited‚Äù:
        // if (data.favorited) btn.remove();
  
        // little pop animation
        icon.classList.remove('heart-pop'); void icon.offsetWidth; icon.classList.add('heart-pop');
      }
    } catch (err) {
      console.error(err);
    }
  });
  </script>

<%- include('../partials/footer') %>
